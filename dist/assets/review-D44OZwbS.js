import{_ as oe,r as k,o as ie,d as i,e as n,f as w,i as L,l as R,k as D,s as Y,F as T,g as I,t as u,h as c,x as ce}from"./index-DEgG3K8i.js";import{r as y}from"./request-DF8rRKj-.js";const ue={class:"page"},re={class:"tabs"},de={key:0},ve={class:"filter"},he=["value"],_e={key:0,class:"stat"},ke=["src","onClick"],fe={class:"info"},pe={class:"title"},me={class:"meta"},ye={class:"meta"},be={class:"tags"},ge={key:0,class:"ops"},we=["disabled","onClick"],Ce=["disabled","onClick"],Te={key:0,class:"empty"},Se={key:1},Ie={class:"filter"},xe=["value"],Ee={key:0,class:"stat"},Ne=["src","onClick"],$e={class:"info"},Ue={class:"title"},Ae={class:"meta"},Oe={class:"meta"},Be={key:0,class:"meta"},Le={key:0},Re={key:1,class:"meta"},je={class:"ops"},Ge=["disabled","onClick"],Me={key:0,class:"empty"},Pe={key:2},De=["onClick"],Ve=["src"],ze={class:"cell"},Fe={class:"name"},qe={class:"chev"},Ze={class:"desc"},He={class:"detail"},Je={class:"detail-row"},Ke={class:"detail-body"},Qe={class:"detail-row"},We={class:"detail-body"},Xe={class:"chip chip-title"},Ye={class:"chips"},et={key:1},tt={class:"detail-row"},st={class:"detail-body"},at={key:0,class:"chips"},nt={key:1},lt={key:0,class:"empty"},ot={key:3,class:"loading"},it={__name:"review",setup(ct){const V={1:"何尔达屋",2:"高利士屋",3:"宾省校屋",4:"端木正教授像",5:"韦耶孝实屋",6:"伦敦会屋",7:"美臣屋一号",8:"白德理屋",9:"屈林宾屋",10:"惠师礼屋",11:"马岗堂",12:"图书馆",13:"黄焕秋校长像",14:"格兰堂",15:"廖承志像",16:"马丁堂",17:"附属小学建筑群",18:"南草坪餐厅",19:"第一教学楼",20:"附属小学方亭",21:"荣光堂",22:"中山大学南门",23:"生命科学楼",24:"蚕丝学院制种室",25:"生物楼",26:"达尔文雕塑",27:"曾宪梓堂",28:"蒲蛰龙雕塑",29:"马文辉堂",30:"贺丹青堂",31:"测试大楼",32:"竹林",33:"中山楼",34:"梁銶琚堂",35:"研究生院",36:"张弼士堂",37:"逸夫楼",38:"西大操场",39:"洗为坚堂",40:"紫荆园餐厅",41:"协和神学院建筑群",42:"芙兰堂",43:"锡昌堂",44:"四墩楼",45:"8号住宅",46:"孖屋二",47:"谭礼庭屋",48:"马应彪夫人护养院",49:"麻金墨屋二号",50:"怀士堂",51:"鲁迅先生像",52:"校训雕像",53:"希伦高屋",54:"黑石屋",55:"麻金墨屋一号",56:"美臣屋二号",57:"神甫屋",58:"积臣屋",59:"英东体育馆",60:"新女学",61:"“摇篮”铜像",62:"冼星海半身铜像",63:"翘燊堂、文虎堂",64:"松涛园",65:"新体育馆",66:"松园湖",67:"第二教学楼",68:"卡彭特楼",69:"林护堂、黄铭衍堂与黄传经堂",70:"叶葆定堂",71:"中山大学北门牌坊",72:"伍沾德堂",73:"丰盛堂",74:"中山大学西北门",75:"伍舜德图书馆",76:"岭南堂",77:"马应彪招待室",78:"哲生堂",79:"陆佑堂",80:"爪哇堂",81:"博物馆",82:"八角亭",83:"乙丑进士牌坊",84:"惺亭",85:"孙中山先生铜像",86:"史达理堂",87:"激光光学大楼",88:"十友堂",89:"模范村",90:"法学院",91:"永芳堂",92:"人口研究所",93:"学人书境",94:"中山大学人文高等研究院",95:"康乐园餐厅",96:"园西湖",97:"蒲园食堂",98:"中山大学西门",99:"中山大学小西门",100:"震寰堂",101:"你的见闻"},p=k(!1),b=k("checkins"),z=k([{value:"pending",label:"待审核"},{value:"approved",label:"已通过"}]),j=k(0),m=k([]),_=k(null),f=k({}),F=k([{value:"all",label:"全部"},{value:"unpicked",label:"未被捡"},{value:"picked",label:"已被捡"}]),G=k(0),C=k([]),E=k(null),N=k({}),U=k([]),$=k({}),S=k({}),q=k([]),A=k([]);ie(()=>{document.title="审核管理",Z()});function M(t){t!==b.value&&(b.value=t,Z())}function Z(){if(b.value==="checkins")return B();if(b.value==="bottles")return Q();if(b.value==="users")return ae()}function O(t){if(!t)return"";let s=t;typeof s=="string"&&/^\d+$/.test(s)&&(s=Number(s));try{return new Date(s).toLocaleString("zh-CN",{timeZone:"Asia/Shanghai"})}catch{return String(t)}}function P(t){return O(t)}function x(t){var e;return((t==null?void 0:t.status)===200||(t==null?void 0:t.statusCode)===200)&&((e=t==null?void 0:t.data)==null?void 0:e.code)===0}function H(t){var e;const s=(t==null?void 0:t.status)??(t==null?void 0:t.statusCode);return s===204||s===200&&((e=t==null?void 0:t.data)==null?void 0:e.code)===0}function J(t){t&&window.open(t,"_blank","noopener,noreferrer")}async function B(){p.value=!0;try{const t=z.value[j.value].value,[s,e,l]=await Promise.all([y(`/admin/checkins?status=${encodeURIComponent(t)}`,"GET"),y("/admin/checkins?status=pending","GET"),y("/admin/checkins?status=approved","GET")]),r=a=>x(a)?a.data.list||[]:[],h=r(s).map(a=>({...a,status:a.status||t,_uploadTime:P(a.uploadTime||a.createdAt),_locName:V[a.locationId]||`#${a.locationId}`})),v={pending:r(e).length,approved:r(l).length};m.value=h,_.value=v}catch(t){console.warn("[admin] fetchCheckins error",t),m.value=[],_.value=null}finally{p.value=!1}}function K(t,s){const e=m.value.findIndex(r=>r.id===t);if(e===-1)return;const l=m.value[e];return m.value.splice(e,1),_.value&&(s==="approve"?(_.value.pending=Math.max(0,(_.value.pending||0)-1),_.value.approved=(_.value.approved||0)+1):_.value.pending=Math.max(0,(_.value.pending||0)-1)),l}async function ee(t){if(!t||f.value[t])return;const s=m.value.slice(),e=_.value?{..._.value}:null;K(t,"approve"),f.value={...f.value,[t]:!0};try{let l=await y(`/admin/checkins/${encodeURIComponent(t)}/approve`,"POST",{});if(!H(l))throw new Error("approve failed");B()}catch{m.value=s,e&&(_.value=e),alert("审核失败，请重试")}finally{const l={...f.value};delete l[t],f.value=l}}async function te(t){if(!t||f.value[t]||!window.confirm("确认驳回该打卡吗？"))return;const e=m.value.slice(),l=_.value?{..._.value}:null;K(t,"reject"),f.value={...f.value,[t]:!0};try{let r=await y(`/admin/checkins/${encodeURIComponent(t)}/reject`,"POST",{});if(!H(r))throw new Error("reject failed");B()}catch{m.value=e,l&&(_.value=l),alert("驳回失败，请重试")}finally{const r={...f.value};delete r[t],f.value=r}}async function Q(){var t;p.value=!0;try{const s=F.value[G.value].value,e=await y(`/admin/bottles?status=${encodeURIComponent(s)}`,"GET"),l={};if(x(e)&&((e.data.users||[]).forEach(d=>{l[String(d.id)]=d.username||""}),!Object.keys(l).length))try{const d=await y("/admin/users","GET");(x(d)?d.data.users||d.data.list||[]:[]).forEach(X=>{l[String(X.id)]=X.username||""})}catch{}const r=x(e)?e.data.list||e.data.bottles||[]:[],h=o=>{if(Array.isArray(o.picks))return o.picks;const d=[];return o.pickedBy&&d.push({userId:o.pickedBy,pickTime:o.pickTime||0}),d},v=r.map(o=>{const d=h(o).map(g=>({...g,name:l[String(g.userId)]||"",_pickTime:P(g.pickTime)}));return{...o,_uploadTime:P(o.uploadTime),_pickerNames:d.map(g=>g.name).filter(Boolean).join("、"),_picks:d}});let a=((t=e==null?void 0:e.data)==null?void 0:t.stat)||null;if(!a){const o=v.length,d=v.filter(g=>Array.isArray(g._picks)&&g._picks.length>0).length;a={all:o,picked:d,unpicked:o-d}}C.value=v,E.value=a}catch(s){console.warn("[admin] fetchBottles error",s),C.value=[],E.value=null}finally{p.value=!1}}function W(t){var e;const s=(t==null?void 0:t.status)??(t==null?void 0:t.statusCode);return s===204||s===200&&((e=t==null?void 0:t.data)==null?void 0:e.code)===0}async function se(t){const s=typeof t=="object"?t.id:t;if(!s)return;const e=C.value.find(o=>o.id===s);if(!window.confirm(`确认删除该漂流瓶${e!=null&&e.text?"“"+String(e.text).slice(0,20)+(String(e.text).length>20?"…":"")+"”":""}吗？`))return;N.value={...N.value,[s]:!0};const r=C.value.slice(),h=C.value.findIndex(o=>o.id===s);h>=0&&C.value.splice(h,1);let v=!1;try{let o=await y(`/admin/bottles/${encodeURIComponent(s)}`,"DELETE",{});W(o)||(o=await y(`/admin/bottles/${encodeURIComponent(s)}/delete`,"POST",{})),v=W(o)}catch{}v||(C.value=r,alert("删除失败"));const a={...N.value};delete a[s],N.value=a}async function ae(){p.value=!0;try{const[t,s]=await Promise.all([y("/admin/users","GET"),y("/admin/bottles?status=all","GET")]);let e=x(t)?t.data.users||t.data.list||[]:[];const l=x(s)?s.data.list||s.data.bottles||[]:[];q.value=l;const r=l.reduce((h,v)=>{const a=Number(v.ownerId);return a&&(h[a]=(h[a]||0)+1),h},{});e=e.map(h=>{const v=Array.isArray(h.bottlesThrow)?h.bottlesThrow.length:null,a=r[Number(h.id)]||0;return{...h,threw:v!==null?v:a}}),U.value=e}catch(t){console.warn("[admin] fetchUsers error",t),U.value=[]}finally{p.value=!1}}async function ne(){if(!A.value.length)try{const t=await y("/admin/checkins?status=approved","GET");A.value=x(t)?t.data.list||[]:[]}catch{A.value=[]}}async function le(t){const s=t.id;if($.value={...$.value,[s]:!$.value[s]},!!$.value[s]&&!S.value[s]){await ne();const e=t.registerTime||t.createdAt||t.created_at||t.signupTime||0,l=e?O(e):"—",r=(q.value||[]).filter(a=>Number(a.ownerId)===Number(s)).map(a=>a.uploadTime).sort((a,o)=>(o||0)-(a||0)).map(O),v=(A.value||[]).filter(a=>Number(a.userId)?Number(a.userId)===Number(s):a.username&&t.username?String(a.username)===String(t.username):!1).reduce((a,o)=>{const d=o.locationId||o.locId||o.location||0;return d&&(a[d]=a[d]||[]).push(o.uploadTime||o.createdAt||o.time||0),a},{});Object.keys(v).forEach(a=>{v[a]=v[a].sort((o,d)=>(d||0)-(o||0)).map(O)}),S.value={...S.value,[s]:{regTimeText:l,checkins:v,throws:r}}}}return(t,s)=>(c(),i("div",ue,[n("div",re,[n("button",{class:L(["tab",{active:b.value==="checkins"}]),onClick:s[0]||(s[0]=e=>M("checkins"))},"打卡审核",2),n("button",{class:L(["tab",{active:b.value==="bottles"}]),onClick:s[1]||(s[1]=e=>M("bottles"))},"漂流瓶",2),n("button",{class:L(["tab",{active:b.value==="users"}]),onClick:s[2]||(s[2]=e=>M("users"))},"用户",2)]),b.value==="checkins"?(c(),i("div",de,[n("div",ve,[n("label",null,[s[5]||(s[5]=R(" 状态： ",-1)),D(n("select",{"onUpdate:modelValue":s[3]||(s[3]=e=>j.value=e),onChange:B},[(c(!0),i(T,null,I(z.value,(e,l)=>(c(),i("option",{key:e.value,value:l},u(e.label),9,he))),128))],544),[[Y,j.value,void 0,{number:!0}]])]),_.value?(c(),i("div",_e," 待审核 "+u(_.value.pending)+" · 已通过 "+u(_.value.approved),1)):w("",!0)]),(c(!0),i(T,null,I(m.value,e=>(c(),i("div",{key:e.id,class:"card"},[n("img",{class:"thumb",src:e.photo,alt:"照片",onClick:l=>J(e.photo)},null,8,ke),n("div",fe,[n("div",pe,u(e.username),1),n("div",me,"地点："+u(e._locName)+"（#"+u(e.locationId)+"）",1),n("div",ye,"提交："+u(e._uploadTime),1),n("div",be,[n("span",{class:L(["tag",e.status])},u(e.status==="pending"?"待审核":"已通过"),3)])]),e.status==="pending"?(c(),i("div",ge,[n("button",{class:"btn btn-primary",disabled:!!f.value[e.id]||p.value,onClick:l=>ee(e.id)},u(f.value[e.id]?"处理中…":"通过"),9,we),n("button",{class:"btn btn-warn",disabled:!!f.value[e.id]||p.value,onClick:l=>te(e.id)},u(f.value[e.id]?"处理中…":"驳回"),9,Ce)])):w("",!0)]))),128)),!p.value&&(!m.value||!m.value.length)?(c(),i("div",Te,"暂无数据")):w("",!0)])):w("",!0),b.value==="bottles"?(c(),i("div",Se,[n("div",Ie,[n("label",null,[s[6]||(s[6]=R(" 状态： ",-1)),D(n("select",{"onUpdate:modelValue":s[4]||(s[4]=e=>G.value=e),onChange:Q},[(c(!0),i(T,null,I(F.value,(e,l)=>(c(),i("option",{key:e.value,value:l},u(e.label),9,xe))),128))],544),[[Y,G.value,void 0,{number:!0}]])]),E.value?(c(),i("div",Ee," 全部 "+u(E.value.all)+" · 未被捡 "+u(E.value.unpicked)+" · 已被捡 "+u(E.value.picked),1)):w("",!0)]),(c(!0),i(T,null,I(C.value,e=>(c(),i("div",{key:e.id,class:"card"},[n("img",{class:"thumb",src:e.photo,alt:"漂流瓶图片",onClick:l=>J(e.photo)},null,8,Ne),n("div",$e,[n("div",Ue,u(e.text||"（无文字内容）"),1),n("div",Ae,"发送人："+u(e.ownerName),1),n("div",Oe,"发送时间："+u(e._uploadTime),1),e._picks&&e._picks.length?(c(),i("div",Be,[s[7]||(s[7]=R(" 拾取人： ",-1)),(c(!0),i(T,null,I(e._picks,(l,r)=>(c(),i(T,{key:l.userId+"-"+r},[n("span",null,u(l.name||"#"+l.userId),1),n("span",null,"（"+u(l._pickTime)+"）",1),r<e._picks.length-1?(c(),i("span",Le,"、")):w("",!0)],64))),128))])):(c(),i("div",Re,"拾取人：—"))]),n("div",je,[n("button",{class:"btn btn-warn",disabled:!!N.value[e.id]||p.value,onClick:l=>se(e)},u(N.value[e.id]?"删除中…":"删除"),9,Ge)])]))),128)),!p.value&&(!C.value||!C.value.length)?(c(),i("div",Me,"暂无漂流瓶")):w("",!0)])):w("",!0),b.value==="users"?(c(),i("div",Pe,[(c(!0),i(T,null,I(U.value,e=>{var l,r,h,v;return c(),i("div",{key:e.id},[n("div",{class:"row row-click",onClick:a=>le(e)},[n("img",{class:"avatar",src:e.avatar,alt:"头像"},null,8,Ve),n("div",ze,[n("div",Fe,[R(u(e.username)+"（"+u(e.role)+"） ",1),n("span",qe,u($.value[e.id]?"▾":"▸"),1)]),n("div",Ze," 已解锁："+u(e.unlocked)+"　审核中："+u(e.locking)+"　扔瓶："+u(e.threw),1)])],8,De),D(n("div",He,[n("div",Je,[s[8]||(s[8]=n("div",{class:"detail-title"},"注册时间",-1)),n("div",Ke,u(((l=S.value[e.id])==null?void 0:l.regTimeText)||"—"),1)]),n("div",Qe,[s[9]||(s[9]=n("div",{class:"detail-title"},"各地点打卡时间",-1)),n("div",We,[(r=S.value[e.id])!=null&&r.checkins&&Object.keys(S.value[e.id].checkins).length?(c(!0),i(T,{key:0},I(S.value[e.id].checkins,(a,o)=>(c(),i("div",{key:e.id+"-"+o,class:"chips-line"},[n("div",Xe,u(V[o]||"#"+o),1),n("div",Ye,[(c(!0),i(T,null,I(a,(d,g)=>(c(),i("span",{key:e.id+"-"+o+"-"+g,class:"chip"},u(d),1))),128))])]))),128)):(c(),i("span",et,"—"))])]),n("div",tt,[s[10]||(s[10]=n("div",{class:"detail-title"},"扔瓶时间",-1)),n("div",st,[(v=(h=S.value[e.id])==null?void 0:h.throws)!=null&&v.length?(c(),i("div",at,[(c(!0),i(T,null,I(S.value[e.id].throws,(a,o)=>(c(),i("span",{key:"throw-"+e.id+"-"+o,class:"chip"},u(a),1))),128))])):(c(),i("span",nt,"—"))])])],512),[[ce,$.value[e.id]]])])}),128)),!p.value&&(!U.value||!U.value.length)?(c(),i("div",lt,"暂无用户")):w("",!0)])):w("",!0),p.value?(c(),i("div",ot,"加载中…")):w("",!0)]))}},dt=oe(it,[["__scopeId","data-v-55e6ccea"]]);export{dt as default};
