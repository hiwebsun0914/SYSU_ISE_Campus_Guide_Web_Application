import{_ as ht,r as f,o as yt,a as _t,p as bt,d as g,e as r,f as D,i as tt,k as F,v as P,t as A,j as kt,u as St,h}from"./index-DEgG3K8i.js";import{r as y}from"./request-DF8rRKj-.js";const xt={class:"signin-page"},Tt={class:"mode-tabs"},Ct={class:"login-box"},Et={class:"btn-row"},Ot=["disabled"],It={key:0},Mt={key:1},Bt={key:0,class:"upload-panel"},Ut={class:"upload-row"},Dt=["disabled"],At=["disabled"],Rt={key:0,class:"progress-wrap"},zt={class:"progress-bar"},Nt={class:"progress-text"},qt={key:0},jt={key:1},Lt=1920,et=2,Ft=.8,Pt={__name:"signin",setup($t){const $=St(),K=_t(),m=f("login"),E=f(""),R=f(""),O=f(""),V=f(""),I=f(!1),W=f(!1),_=f(!1),M=f("正在上传头像…"),v=f(0),x=f(""),T=f(""),H=f(null);let b=null,z=null;yt(()=>{var e;document.title=m.value==="login"?"登录":"注册";const t=(e=K.query)!=null&&e.redirect?decodeURIComponent(String(K.query.redirect)):"";V.value=t,ot(Y)}),bt(m,t=>{document.title=t==="login"?"登录":"注册"});function ot(t){return"requestIdleCallback"in window?requestIdleCallback(t,{timeout:1500}):setTimeout(t,200)}function nt(t){return t?/^1[3-9]\d{9}$/.test(String(t)):!0}function at(t="jpg"){const e=String(t||"").toLowerCase();return e==="png"?"image/png":e==="webp"?"image/webp":"image/jpeg"}async function st(){if(!I.value){if(!E.value||!O.value){alert("请输入账号密码");return}if(m.value==="register"&&!nt(R.value)){alert("手机号格式不正确");return}I.value=!0;try{m.value==="login"?(await rt(E.value,O.value),alert("登录成功"),B()):(await it(E.value,O.value,R.value),W.value=!0,G())}catch(t){const e=(t==null?void 0:t.message)||"操作失败，请稍后重试";alert(e)}finally{I.value=!1}}}async function rt(t,e){try{const o=await y("/auth/login","POST",{username:t,password:e});if(!N(o)){const a=J(o);throw a==="USER_NOT_FOUND"?new Error("账号不存在"):a==="BAD_PASSWORD"?new Error("密码错误"):new Error(q(o)||"登录失败")}j(o);return}catch{}if(await lt(t)===!1)throw new Error("账号不存在");try{const o=await y("/login_or_register","POST",{username:t,password:e,phone:"",mode:"login",allowCreate:!1,registerIfNotExist:!1});if(!N(o)){const a=J(o);throw a==="USER_NOT_FOUND"?new Error("账号不存在"):a==="BAD_PASSWORD"?new Error("密码错误"):new Error(q(o)||"登录失败")}j(o)}catch{throw new Error("登录接口不可用或服务异常")}}async function it(t,e,n){try{const a=await y("/auth/register","POST",{username:t,password:e,phone:n});if(!N(a))throw new Error(q(a)||"注册失败");j(a);return}catch{}const o=await y("/login_or_register","POST",{username:t,password:e,phone:n,mode:"register"});if(!N(o))throw new Error(q(o)||"注册失败");j(o)}async function lt(t){try{const e=await y("/auth/user_exists","GET",{username:t}),n=X(e);if(typeof n=="boolean")return n}catch{}try{const e=await y("/user/exists","GET",{username:t}),n=X(e);if(typeof n=="boolean")return n}catch{}return null}function N(t){const e=(t==null?void 0:t.data)||{};return typeof e.code=="number"?e.code===0:typeof(t==null?void 0:t.code)=="number"?t.code===0:t!=null&&t.status&&t.status!==200?!1:!!(e.token||e.userInfo)}function q(t){const e=(t==null?void 0:t.data)||{};return e.message||e.msg||(t==null?void 0:t.statusText)||""}function J(t){const e=(t==null?void 0:t.data)||{},n=e.code,o=(e.message||e.msg||"").toString().toLowerCase();return n===1001||/user.*not.*exist|用户不存在|账号不存在/.test(o)?"USER_NOT_FOUND":n===1002||/password|密码/.test(o)?"BAD_PASSWORD":""}function j(t){var i,a;const e=(t==null?void 0:t.data)||{},n=e.token||((i=e.data)==null?void 0:i.token),o=e.userInfo||((a=e.data)==null?void 0:a.userInfo)||{};n&&localStorage.setItem("token",n),localStorage.setItem("userInfo",JSON.stringify(o))}function X(t){const e=(t==null?void 0:t.data)||{};if(typeof e.exists=="boolean")return e.exists;if(e.data&&typeof e.data.exists=="boolean")return e.data.exists}function G(){var t;(t=H.value)==null||t.click()}function ut(){B()}function ct(){try{b&&b.abort(),z&&window.COS&&window.__cos__&&window.__cos__.cancelTask(z)}catch{}}async function dt(t){var n,o,i;const e=(n=t.target.files)==null?void 0:n[0];if(t.target.value="",!e){B();return}try{let a=e;e.size>Ft*1024*1024&&(M.value="正在压缩图片…",a=await wt(e,Lt)||e),_.value=!0,v.value=0,x.value="",T.value="",M.value="正在上传头像…";const s=(e.name.split(".").pop()||"jpg").toLowerCase(),l=await y("/avatar/init","POST",{ext:s});if(((o=l==null?void 0:l.data)==null?void 0:o.code)!==0){alert("获取上传凭证失败"),B();return}const{bucket:u,region:c,key:w,credentials:d,putUrl:C}=l.data.data||{},k=a.type||at(s);let S=!1;for(let p=0;p<=et&&!S;p++)try{C?await ft(C,a,k,(L,vt,gt)=>{v.value=L,x.value=vt,T.value=gt}):await mt({bucket:u,region:c,key:w,credentials:d,file:a,mime:k}),S=!0}catch(L){if(p>=et)throw L;await pt(500*(p+1))}M.value="正在绑定头像…";const U=await y("/avatar/commit","POST",{key:w,size:a.size,mime:k});if(((i=U==null?void 0:U.data)==null?void 0:i.code)===0){const p=JSON.parse(localStorage.getItem("userInfo")||"{}");p.avatar=U.data.avatar_url,localStorage.setItem("userInfo",JSON.stringify(p)),alert("头像已设置")}else alert("头像绑定失败")}catch(a){console.error("[avatar] upload error:",a),(a==null?void 0:a.name)==="AbortError"?alert("已取消上传"):alert("头像上传失败")}finally{_.value=!1,v.value=0,x.value="",T.value="",M.value="正在上传头像…",B()}}function ft(t,e,n,o){return new Promise((i,a)=>{const s=new XMLHttpRequest;b=new AbortController;let l=0,u=Date.now();s.upload.onprogress=c=>{if(!c.lengthComputable){o==null||o(Math.min(99,v.value||0),"","");return}const w=c.loaded/c.total*100,d=Date.now(),C=c.loaded-l,k=d-u||1,S=C/(k/1e3);l=c.loaded,u=d;const p=(c.total-c.loaded)/(S||1);o==null||o(Math.min(99,w),Q(S),Z(p))},s.onload=()=>{b=null,s.status>=200&&s.status<300?(o==null||o(100,"",""),i()):a(new Error("PUT 上传失败 "+s.status))},s.onerror=()=>{b=null,a(new Error("网络错误"))},s.onabort=()=>{b=null,a(new DOMException("aborted","AbortError"))},s.open("PUT",t,!0),s.setRequestHeader("Content-Type",n),s.send(e),b.signal.addEventListener("abort",()=>{try{s.abort()}catch{}})})}async function mt({bucket:t,region:e,key:n,credentials:o,file:i,mime:a}){await Y();const s=window.COS,l=window.__cos__||new s({getAuthorization:(u,c)=>{c({TmpSecretId:o.tmpSecretId,TmpSecretKey:o.tmpSecretKey,SecurityToken:o.sessionToken,StartTime:o.startTime,ExpiredTime:o.expiredTime})}});return window.__cos__=l,new Promise((u,c)=>{const w=l.sliceUploadFile({Bucket:t,Region:e,Key:n,Body:i,Headers:{"x-cos-acl":"public-read","Content-Type":a},onProgress:d=>{const C=Math.min(99,(d.percent||0)*100),k=d.speed||0,S=d.estimatedTimeRemaining||0;v.value=C,x.value=Q(k),T.value=Z(S)}},d=>{z=null,d?c(d):(v.value=100,u())});z=w&&w.id})}function Y(){return window.COS?Promise.resolve():new Promise((t,e)=>{const n=["https://cdn.staticfile.org/cos-js-sdk-v5/1.6.3/cos-js-sdk-v5.min.js","https://unpkg.com/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"];let o=0;const i=()=>{const a=document.createElement("script");a.src=n[o++],a.onload=()=>window.COS?t():o<n.length?i():e(new Error("COS SDK load failed")),a.onerror=()=>o<n.length?i():e(new Error("COS SDK load failed")),document.head.appendChild(a)};i()})}async function wt(t,e=1920){try{const n=await createImageBitmap(t),{width:o,height:i}=n,a=Math.min(1,e/Math.max(o,i)),s=Math.max(1,Math.round(o*a)),l=Math.max(1,Math.round(i*a)),u=typeof OffscreenCanvas<"u"?new OffscreenCanvas(s,l):document.createElement("canvas");u.width=s,u.height=l,u.getContext("2d",{alpha:!1}).drawImage(n,0,0,s,l);const w=await new Promise(d=>{if(u.convertToBlob){u.convertToBlob({type:"image/webp",quality:.8}).then(d);return}u.toBlob(d,"image/webp",.8)});return w?new File([w],(t.name.replace(/\.\w+$/,"")||"avatar")+".webp",{type:"image/webp"}):null}catch(n){return console.warn("[compress] fallback to original:",n),null}}function pt(t){return new Promise(e=>setTimeout(e,t))}function Q(t){if(!t||t<=0)return"";const e=1024,n=e*1024;return t>=n?(t/n).toFixed(1)+" MB/s":(t/e).toFixed(0)+" KB/s"}function Z(t){if(!t||t<=0||t===1/0)return"";const e=Math.ceil(t);if(e<60)return`${e}s`;const n=Math.floor(e/60),o=e%60;return o?`${n}m${o}s`:`${n}m`}function B(){var e;const t=(e=V.value)==null?void 0:e.trim();t?$.replace(t):$.replace("/profile")}return(t,e)=>(h(),g("div",xt,[e[6]||(e[6]=r("img",{class:"bg-img",src:"https://sysuzngcxy-1322240898.cos.ap-guangzhou.myqcloud.com/bg.jpg",alt:"bg"},null,-1)),e[7]||(e[7]=r("div",{class:"logo-container"},[r("img",{class:"logo-img",src:"https://sysuzngcxy-1322240898.cos.ap-guangzhou.myqcloud.com/logo1.png",alt:"logo"})],-1)),r("div",Tt,[r("button",{class:tt(["tab",m.value==="login"&&"active"]),onClick:e[0]||(e[0]=n=>m.value="login")},"登录",2),r("button",{class:tt(["tab",m.value==="register"&&"active"]),onClick:e[1]||(e[1]=n=>m.value="register")},"注册",2)]),r("div",Ct,[F(r("input",{class:"input",placeholder:"请输入昵称","onUpdate:modelValue":e[2]||(e[2]=n=>E.value=n)},null,512),[[P,E.value,void 0,{trim:!0}]]),m.value==="register"?F((h(),g("input",{key:0,class:"input",placeholder:"请输入手机号（仅用于联系）",inputmode:"numeric",maxlength:"11","onUpdate:modelValue":e[3]||(e[3]=n=>R.value=n)},null,512)),[[P,R.value,void 0,{trim:!0}]]):D("",!0),F(r("input",{class:"input",placeholder:"请输入密码",type:"password","onUpdate:modelValue":e[4]||(e[4]=n=>O.value=n)},null,512),[[P,O.value]])]),r("div",Et,[r("button",{class:"login-btn",disabled:I.value||_.value,onClick:st},[_.value?(h(),g("span",It,A(M.value),1)):(h(),g("span",Mt,A(I.value?"提交中…":m.value==="login"?"登录":"注册并上传头像"),1))],8,Ot)]),W.value?(h(),g("div",Bt,[r("div",Ut,[r("input",{ref_key:"fileInput",ref:H,type:"file",accept:"image/*",style:{display:"none"},onChange:dt},null,544),r("button",{class:"secondary-btn",onClick:G,disabled:_.value},"选择头像",8,Dt),r("button",{class:"secondary-btn",onClick:ut,disabled:_.value},"跳过",8,At)]),_.value?(h(),g("div",Rt,[r("div",zt,[r("div",{class:"progress-inner",style:kt({width:v.value+"%"})},null,4)]),r("div",Nt,[r("span",null,A(v.value.toFixed(0))+"%",1),x.value?(h(),g("span",qt,"｜"+A(x.value),1)):D("",!0),T.value?(h(),g("span",jt,"｜剩余 "+A(T.value),1)):D("",!0),r("button",{class:"link-btn",onClick:ct},"取消上传")])])):D("",!0),e[5]||(e[5]=r("div",{class:"tip-text"},"支持 jpg/png/webp；会自动压缩到较小体积以加快上传。",-1))])):D("",!0)]))}},Wt=ht(Pt,[["__scopeId","data-v-216c0535"]]);export{Wt as default};
