import{_ as ie,r as a,o as re,u as ce,b as ue,d as v,e as s,f as L,l as Y,t as h,k as de,v as fe,F as ve,g as he,w as Z,a as me,h as m}from"./index-DEgG3K8i.js";import{r as T}from"./request-DF8rRKj-.js";import{a as H}from"./auth-M6tedSfb.js";const ge={class:"page"},pe={class:"logo-wrap"},we={key:0,class:"logo",src:"https://sysuzngcxy-1322240898.cos.ap-guangzhou.myqcloud.com/logo1.png",alt:"logo"},ye={key:1,class:"logo",src:"https://sysuzngcxy-1322240898.cos.ap-guangzhou.myqcloud.com/logo.png",alt:"logo"},_e={class:"quota"},ke={class:"total"},Te={class:"total"},be={class:"composer"},xe={class:"ta-wrap"},Ie={key:0,class:"input-ph"},Me={class:"tool"},Ce={class:"count"},Ee=["disabled"],Be={class:"section"},Se=["disabled"],Le=["src","onClick"],Pe={class:"content"},Oe={class:"text"},Re={class:"meta"},Ue={key:0,class:"empty"},$e={key:1,class:"loading"},qe=["src"],E=50,J=6,ze={__name:"message",setup(He){const P=ce();me();const r=a(!1),O=a("visitor"),B=a(0),N=a(0),F=a(null),g=a(""),R=a(!1),K=["今天在荣光堂前遇见好天气 ☀️","如果你也在这附近，欢迎留言交流～","欢迎联系我：微信/QQ"],V=a(""),u=a({offset:0,hasMore:!0}),p=a(!1),f=a([]),A=a(null),U=a(!1),$=a("");function W(t){t&&($.value=t,U.value=!0)}function Q(){U.value=!1,$.value=""}let w=null,b=null;const q=a(null);re(async()=>{if(document.title="漂流瓶",V.value=`写点想说的话…（可在最后留下联系方式）

`+K.map((t,e)=>`${e+1}. ${t}`).join(`
`),!z()){const t=encodeURIComponent("/message");P.push({path:"/signin",query:{redirect:t}});return}await oe(),await G(),await le(),ee()}),ue(()=>{w&&(w.disconnect(),w=null),b&&(clearTimeout(b),b=null),window.removeEventListener("scroll",D)});function ee(){w&&w.disconnect(),"IntersectionObserver"in window&&(w=new IntersectionObserver(t=>{const e=t[0];e!=null&&e.isIntersecting&&u.value.hasMore&&!p.value&&X()},{root:null,rootMargin:"200px 0px",threshold:.01}),q.value&&w.observe(q.value)),window.addEventListener("scroll",D,{passive:!0})}function D(){if(p.value||!u.value.hasMore)return;const t=window.pageYOffset||document.documentElement.scrollTop||0,e=window.innerHeight||document.documentElement.clientHeight||0;Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight)-(t+e)<240&&(b&&clearTimeout(b),b=setTimeout(()=>X(),80))}function z(){var t,e;try{return typeof((t=H)==null?void 0:t.isLoggedIn)=="function"?H.isLoggedIn():!!((e=H)!=null&&e.isLoggedIn)}catch{return!1}}function S(t){if(!t)return"";let e=t;typeof e=="string"&&/^\d+$/.test(e)&&(e=Number(e));try{return new Date(e).toLocaleString()}catch{return String(t)}}function y(t){var o;return((t==null?void 0:t.status)===200||(t==null?void 0:t.statusCode)===200)&&((o=t==null?void 0:t.data)==null?void 0:o.code)===0}async function te(t,e=1080,o=.8){return new Promise((n,i)=>{const d=new FileReader;d.onload=c=>{const l=new Image;l.onload=()=>{const x=document.createElement("canvas");let _=l.width,k=l.height;_>e&&(k=Math.round(k*e/_),_=e),x.width=_,x.height=k,x.getContext("2d").drawImage(l,0,0,_,k),x.toBlob(C=>{if(!C)return i(new Error("压缩失败"));const M=new File([C],t.name,{type:C.type});n(M)},"image/jpeg",o)},l.onerror=i,l.src=c.target.result},d.onerror=i,d.readAsDataURL(t)})}async function oe(){var t,e;try{const o=await T("/auth/me","GET");y(o)&&(O.value=((t=o.data.userInfo)==null?void 0:t.role)||"visitor",F.value=((e=o.data.userInfo)==null?void 0:e.id)||null)}catch{}}async function G(){try{const t=await T("/auth/me","GET");if(y(t)){const e=t.data.userInfo||{},o=(e.unlockedLocations||[]).length+3,n=(e.bottlesThrow||[]).length;N.value=o,B.value=Math.max(o-n,0),F.value=e.id||null}}catch(t){console.warn("[message] refreshQuota fail",t)}}function se(){var t;if(!z()){const e=encodeURIComponent("/message");P.push({path:"/signin",query:{redirect:e}});return}if(B.value<=0){alert("可扔瓶子数量为 0");return}if(g.value.length>E){alert(`文字最多 ${E} 字`);return}(t=A.value)==null||t.click()}async function ae(t){var o,n,i,d;let e=(o=t.target.files)==null?void 0:o[0];if(t.target.value="",!!e)try{e=await te(e,1080,.8),r.value=!0;const c=(e.name.split(".").pop()||"jpg").toLowerCase(),l=await T("/checkin/presign","POST",{ext:c,locationId:"Bottle",dir:"Bottle"});if(!y(l)){alert(((n=l==null?void 0:l.data)==null?void 0:n.message)||"签名失败"),r.value=!1;return}const{key:x,putUrl:_}=l.data.data||{},k=await fetch(_,{method:"PUT",headers:{"Content-Type":e.type||"image/jpeg"},body:e});if(!k.ok){alert("上传失败 "+k.status),r.value=!1;return}const I=await T("/checkin/commit","POST",{key:x,size:e.size});if(!y(I)){alert(((i=I==null?void 0:I.data)==null?void 0:i.message)||"绑定失败"),r.value=!1;return}const C=I.data.url,M=await T("/bottle/throw","POST",{text:g.value||"",photo:C});if(!y(M)){alert(((d=M==null?void 0:M.data)==null?void 0:d.message)||"扔瓶失败"),r.value=!1;return}g.value="",await G(),alert("已扔出一个瓶子")}catch(c){console.error("throwBottle error =>",c),alert("网络异常")}finally{r.value=!1}}async function ne(){var t;if(!z()){const e=encodeURIComponent("/message");P.push({path:"/signin",query:{redirect:e}});return}try{r.value=!0;const e=await T("/bottle/pick","POST",{});if(!y(e)){alert(((t=e==null?void 0:e.data)==null?void 0:t.message)||"捞取失败");return}const o=e.data.bottle;if(!o){alert("暂无可捡的瓶子");return}const n={id:o.id,text:o.text||"",photo:o.photo||"",ownerId:o.ownerId,ownerName:o.ownerName||"",uploadTime:S(o.uploadTime),pickTime:S(o.pickTime)},i=f.value.findIndex(d=>String(d.id)===String(n.id));i>=0&&f.value.splice(i,1),f.value.unshift(n),alert("捡到一个瓶子")}catch(e){console.error("[message] pickBottle error",e),alert("网络异常")}finally{r.value=!1}}async function j(t,e){try{const o=await T(`/bottle/my-picked?limit=${e}&offset=${t}`,"GET");if(!y(o)||!Array.isArray(o.data.list))return{list:[],hasMore:!1};const n=o.data.list.slice().sort((c,l)=>(l.pickTime||0)-(c.pickTime||0)),i=n.map(c=>({...c,uploadTime:S(c.uploadTime),pickTime:S(c.pickTime)})),d=typeof o.data.hasMore=="boolean"?o.data.hasMore:n.length===e;return{list:i,hasMore:d}}catch(o){return console.warn("[message] fetchPickedBatch fail",o),{list:[],hasMore:!1}}}async function le(){p.value=!0;try{u.value.offset=0,u.value.hasMore=!0,f.value=[];const{list:t,hasMore:e}=await j(0,J);f.value=t,u.value.offset=t.length,u.value.hasMore=e}finally{p.value=!1}}async function X(){if(!(!u.value.hasMore||p.value)){p.value=!0;try{const{list:t,hasMore:e}=await j(u.value.offset,J);t.forEach(o=>{f.value.find(i=>String(i.id)===String(o.id))||f.value.push(o)}),u.value.offset+=t.length,u.value.hasMore=e}finally{p.value=!1}}}return(t,e)=>(m(),v("div",ge,[e[7]||(e[7]=s("img",{class:"bg",src:"https://sysuzngcxy-1322240898.cos.ap-guangzhou.myqcloud.com/bg.jpg",alt:"bg"},null,-1)),s("div",pe,[O.value==="participant"||O.value==="admin"?(m(),v("img",we)):(m(),v("img",ye))]),s("div",_e,[e[4]||(e[4]=Y(" 可扔的漂流瓶： ",-1)),s("span",ke,h(B.value),1),e[5]||(e[5]=Y("/",-1)),s("span",Te,h(N.value),1)]),s("div",be,[s("div",xe,[de(s("textarea",{class:"input",maxlength:E,"onUpdate:modelValue":e[0]||(e[0]=o=>g.value=o),onFocus:e[1]||(e[1]=o=>R.value=!0),onBlur:e[2]||(e[2]=o=>R.value=!1)},null,544),[[fe,g.value]]),!g.value&&!R.value?(m(),v("div",Ie,h(V.value),1)):L("",!0)]),s("div",Me,[s("span",Ce,h(g.value.length)+"/"+h(E),1),s("button",{class:"btn primary",disabled:r.value||B.value<=0||g.value.length>E,onClick:se}," 上传图片并扔一个 ",8,Ee)])]),s("div",Be,[e[6]||(e[6]=s("div",{class:"title"},"随机捡到的漂流瓶",-1)),s("button",{class:"btn ghost sm",disabled:r.value,onClick:ne},"捞一个",8,Se)]),(m(!0),v(ve,null,he(f.value,o=>(m(),v("div",{key:o.id,class:"card"},[s("img",{class:"photo",src:o.photo,alt:"bottle",onClick:n=>W(o.photo)},null,8,Le),s("div",Pe,[s("div",Oe,h(o.text),1),s("div",Re,[s("span",null,"来自："+h(o.ownerName),1),s("span",null,"抛出："+h(o.uploadTime),1),s("span",null,"拾取："+h(o.pickTime),1)])])]))),128)),!r.value&&f.value.length===0?(m(),v("div",Ue," 还没有捡到瓶子，先扔一个吧～ ")):L("",!0),s("div",{ref_key:"sentinel",ref:q,class:"sentinel","aria-hidden":"true"},null,512),r.value?(m(),v("div",$e,"处理中…")):L("",!0),s("input",{ref_key:"fileInput",ref:A,type:"file",accept:"image/*",style:{display:"none"},onChange:ae},null,544),U.value?(m(),v("div",{key:2,class:"viewer-mask",onClick:Q},[s("div",{class:"viewer-swiper",onClick:e[3]||(e[3]=Z(()=>{},["stop"]))},[s("img",{class:"viewer-img",src:$.value,alt:"预览"},null,8,qe)]),s("div",{class:"viewer-close",onClick:Z(Q,["stop"])},"×")])):L("",!0)]))}},Ae=ie(ze,[["__scopeId","data-v-2371c871"]]);export{Ae as default};
